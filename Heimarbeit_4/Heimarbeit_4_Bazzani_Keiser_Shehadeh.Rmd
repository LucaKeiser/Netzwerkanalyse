---
title: "Aufgabenblatt zur Heimarbeit 4"
author: "Luca"
date: '2022-05-26'
output: html_document
editor_options: 
  chunk_output_type: console
---

## Aufgabenblatt zur Heimarbeit 4
### Methoden der sozialen Netzwerkanalyse




## Anhang  - R-Code

### Heimarbeit4_Bazzani_Keiser_Shehadeh

Bis anhin haben wir unser Netzwerk als Ein-Knoten-Netzwerk dargestellt. Kurz zusammengefasst stellten die Knoten die einzelnen Ständerät:innen dar. Die Kanten bezogen sich auf die gemeinsamen Mitgliedschaften in den jeweiligen Lobby-Organisationen. Alle Kanten des Graphen galten dabei als ungerichtet, da wir davon ausgingen, dass sich die Personen jeweils gegenseitig kennen und wahrnehmen. Wir stellten Verbindungen zwischen Ständeräten dar, die nicht in der gleichen Partei tätig sind und verglichen diese mit dem dichteren Netzwerk mit allen innerparteilicher Edges.

In der Heimarbeit 4 fassen wir die wichtigsten Ergebnisse zusammen. Einerseits zeigen wir auf, wie die Parlamentarier: innen über die Organisationen miteinander verbunden sind und welche Communities entstanden sind. Wir betrachten zuerst die Ergebnisse von den Organisationen und Parlamentarierinnen getrennt an und fügen die Netzwerke als Bipartites Netzwerk mit zwei verschiedenen Knotenattribute zusammen. 

Das Ständerätliche Netzwerk (Abbildung 1.) zeigt auf wie die jeweiligen Ständeräten durch die gemeinsame Einsitzen in den Organisationen miteinander verbunden sind. Je breiter die Kanten, desto mehr Sitze teilen sich die Parlamentarier: innen in der selben Organisation. Die Parlamentarier: innen unterscheiden sich durch die Färbung der Knoten, welche die jeweilige Parteifarben signalisieren. Wie bereits in den vorherigen Heimarbeiten erwähnt, sind insbesondere Mitte-Partei-Mitglieder zentrale Akteure des Netzwerkes. 
Neu betrachten wir dazu das Organisationnetzwerk des Ständerates (Abbildung 2). Die Knoten stellen die Lobbyorganisationen dar und diese werden mit Parlamentarier: innen welche in beiden oder mehrere Organisationen ein Verbindung aufweisen vernetzt. Unterteilt wurden die Organisationen mit der Färbung der Knoten durch Branchenzugehörigkeit. Aus Platzgründen wurden die jeweiligen Kanten entfernt, die eine Gewichtung von <= 1 aufweisen. 
Des Weiteren wollen wir innerhalb der oben beschriebenen Netzwerke Teilgruppen und Communities bestimmen. In der Netzwerksoziologie wird eine Comminity als Subste der Nodes mit einer höheren Kantendichte als der Rest des Netzwerkes definiert (Vergleich Radichhi et. al 2004). Um diese Subsets zu identifizieren wird eine Auswahl an Algorithmen verwendet, wie sie auch von Douglas A. Luke in seiner User's Guide to Network Analysis vorgeschlagen werden. Die Community Detection wird sowohl auf die Parlamentarier:innen als auch das Organisationsnetzwerk angewendet. Basierend auf Douglas A. Lukes Methode (vgl. Luke 2015: 118) versuchten wir in einem ersten Schritt den Algorithmus zu finden, welcher den höchsten Modularitätswert vorweist. Im Falle der Parlamentarier:innen wäre dies *Louvian*. 

Wendet man den Algorithmus auf das Netzwerk an, so werden insgesamt sieben verschiedene Communities identifiziert. Zwei dieser sieben lasssen sich dadurch erklären, dass sie atomisierte und innerhalb des Netzwerkes nicht verbundene Politiker:innen darstellen (Community 6 und 7) (Abbildung 3). Communities eins und zwei weisen eine starke Überschneidung auf und hier sind keine klaren Parteimuster zu erkennen. Gerade in Community 2 sind die Parteien mit vier Grünen und jeweils drei Politiker:innen der SP und SVP relativ ausgeglichen. Die Community 3 besteht ausschliesslich aus FDP und Mitte-Politiker: innen. 

Die Interpretation der identifizierten Communities bleibt dabei in den Händen der Forschenden und die Algorithmen machen tätigen jeweils keine qualitätive Einordnung der identifizierten Subsets.

Wesentlich spannender und eindeutiger gestaltet sich die Community Detection bei den Organisationen. Alle verwendeten Algorithmen kommen hier auf ähnliche Modularitätswert. Der Einfachheit und Vergleichbarkeit halber wurde auch hier der *Louvian*-Algorithmus weitervwerendet. 
Insgesamt konnten 12 distinkte Communities (Abbildung 4) Identifiziert werden. Darunter das primär wirtschaftlich geprägte Netzwerk um die Universität Zürich (Community 1), das ostschweizerische Netzwerk um die Universität St.Gallen (Community 2), Sport und Freizeit in Community 3, Politische Inklusion mit einem Flavour von Ökologie in Community 5, die Glarner Comminity in Community 6, das Zentralschweizer Netz in Community 7, Umwelt und Verkehr in Communities 8 und 9. Communities 4, 10, 11 und 12 konnten nicht klar identifiziert werden, eine Übersicht findet sich in der Tabelle 3.


Zusätzlich betrachten wir unser Netzwerk als Bipartites Netzwerk und erstellen diese anhand der Edgeliste (Parlamentarier: in und Organisation (Event)). Dabei differenzierten wir die Knoten zwischen Parlamentarier: innen (45 Parlamentarier: innen) und die jeweiligen Lobbyorganisationen (636 Organisationen), und zeigen auf über welche Organisationen die jeweiligen Parlamentarier: innen miteinander affiliiert sind( Abbildung xy). 

Hervorheben möchten wir in unserer Netzwerkanalyse, dass es klare Erkennungen der Verbindungen durch die Communities gibt. Wie bereits oben erwähnt besteht Community 3 ausschliesslich aus FDP und Mitte-Politiker: innen. Dies zeigt auf, dass das Netzwerk der Standerät: innen einen klaren mitte-rechts-Bias besitzt. Zusätzlich können wir beobachten, dass grosse Instiutionen, wie die Universitäten Zürich und St. Gallen einen hohen Einflussgrad innerhalb des Organisationsnetzwerkes haben. Auffallend sind auch die Interessen – und standortsbedingten Verbindungen. Dies zeigt sich anhand der Glarner-Community oder auch durch die Verbindungen von VCS, Pro Natura und WWF innerhalb der Community 2. 

```{r}
# Pakete laden
library(tidyverse)
library(tidygraph)
library(ggraph)
library(igraph)
library(knitr)
library(ggforce)

theme_set(theme_light())


# Einsatz meherer Prozessoren
doParallel::registerDoParallel(cores = 4)


# Datensatz laden
doc <- read_delim(here::here("Data", "Lobbywatch", "cartesian_minimal_parlamentarier_interessenbindung.csv"),
                  delim = "\t")

doc_SR <- doc %>% 
  filter(parlamentarier_rat == "SR") %>% 
  filter(organisation_rechtsform != "Parlamentarische Gruppe")
```


## Bipartites Netzwerk

```{r}
# Erstellen eines bipartiten Netzwerks anhand der Edgelist

# Edgelist (Parlamentarier:in und Organisation (Event))
edgelist <- doc_SR %>% 
  select(parlamentarier_name, organisation_name)



# ansehen
edgelist

edgelist %>% 
  count(parlamentarier_name,
        sort = TRUE)

edgelist %>% count(organisation_name, 
                   sort = TRUE)


# Bipartites Netzwerk
SR_bipartite_igraph <- graph.data.frame(edgelist,
                                        directed = TRUE)


# Noch nicht ganz...
SR_bipartite_igraph
list.vertex.attributes(SR_bipartite_igraph)

# Die Konten müssen noch differenziert werden (Parlamentarier:innen vs. Organisationen)
V(SR_bipartite_igraph)$name
edgelist[,1]
edgelist[,2]


V(SR_bipartite_igraph)$type <- V(SR_bipartite_igraph)$name %in% edgelist[,1]$parlamentarier_name


# Jetzt sieht es gut aus!
SR_bipartite_igraph
list.vertex.attributes(SR_bipartite_igraph)

# 45 Parlamentarier:innen und 636 Organisationen
table(get.vertex.attribute(SR_bipartite_igraph)$type)
```


## Knotenattribute

```{r}
# Hinzufügen weiterer Knotenattribute mit tidygraph
SR_bipartite_tidy <- as_tbl_graph(SR_bipartite_igraph)

# Definieren der Knotenattribute

# 1) Parlamentaier:innen
node_attributes_parl <- doc_SR %>% 
  select(parlamentarier_name, parlamentarier_geschlecht, parlamentarier_partei, parlamentarier_kanton) %>% 
  distinct()

# 2) Organisationen
node_attributes_org <- doc_SR %>% 
  select(organisation_name, organisation_ort, organisation_interessengruppe1, organisation_interessengruppe1_branche) %>% 
  distinct()

# Hinzufügen
SR_bipartite_tidy <- SR_bipartite_tidy %>% 
  
  # Knotenattribute (Parlamentarier)
  left_join(node_attributes_parl, 
            by = c("name" = "parlamentarier_name")) %>% 
  # Korrektur für Thomas Minder (Parteilos)
  mutate(parlamentarier_partei = ifelse(name == "Minder, Thomas", "Parleilos", parlamentarier_partei)) %>% 
  
  # Knotenattribute (Organisationen)
  left_join(node_attributes_org,
            by = c("name" = "organisation_name")) %>% 
  rename(sex = parlamentarier_geschlecht,
         party = parlamentarier_partei,
         canton = parlamentarier_kanton,
         location_org = organisation_ort,
         interest_org = organisation_interessengruppe1,
         industry_org = organisation_interessengruppe1_branche)


# aktualisieren des igraph-objekts
SR_bipartite_igraph <- as.igraph(SR_bipartite_tidy)

list.vertex.attributes(SR_bipartite_igraph)

# ansehen
SR_bipartite_tidy %>% 
  activate(nodes) %>% 
  as_tibble() %>% 
  group_by(type) %>% 
  slice_head(n = 10) 


tibble(
  name = V(SR_bipartite_igraph)$name,
  type = V(SR_bipartite_igraph)$type,
  sex = V(SR_bipartite_igraph)$sex,
  party = V(SR_bipartite_igraph)$party,
  canton = V(SR_bipartite_igraph)$canton,
  place = V(SR_bipartite_igraph)$location_org,
  interest = V(SR_bipartite_igraph)$interest_org,
  branche = V(SR_bipartite_igraph)$industry_org
) %>% 
  group_by(type) %>% 
  slice_head(n = 10)
```


## Grafiken


### Bipartites Netzwerk

```{r}
set.seed(12345)
SR_bipartite_tidy %>% 
  ggraph(layout = "fr") +
  geom_edge_link(color = "grey") + 
  geom_node_point(aes(shape = type,
                      color = type),
                  size = 5,
                  show.legend = FALSE) +
  geom_node_text(aes(label = name),
                 size = 2,
                 check_overlap = TRUE) + 
  labs(title = "Bipartites Netzwerk - Parlamentarier:innen und Organisationen",
       caption = "Aus Platzgründen werden nicht alle Namen angezeigt.")
```



### Projektionen

```{r}
# Projektionen
SR_projection <- bipartite.projection(SR_bipartite_igraph)
SR_projection

# 1) Organisationen
SR_organisationen_igraph <- SR_projection$proj1

# 2) Parlamentarier:innen
SR_parlamentarier_igraph <- SR_projection$proj2


# Gewichtung
get.adjacency(SR_organisationen_igraph,
              sparse = FALSE,
              attr = "weight")

get.adjacency(SR_parlamentarier_igraph,
              sparse = FALSE,
              attr = "weight")


# ansehen
# sehr spärlich...
table(E(SR_organisationen_igraph)$weight)
table(E(SR_parlamentarier_igraph)$weight)


# Grafiken werden mit tidygraph erstellt
SR_organisationen_tidy <- as_tbl_graph(SR_organisationen_igraph) %>% 
  mutate(degree = centrality_degree(),
         betweenness = centrality_betweenness(),
         closeness = centrality_closeness())
SR_parlamentarier_tidy <- as_tbl_graph(SR_parlamentarier_igraph) %>% 
  mutate(degree = centrality_degree(),
         betweenness = centrality_betweenness(),
         closeness = centrality_closeness())
```


```{r}
# Organisationsnetzwerk ist viel zu gross...
# Kann anhand meherer Kriterien gefiltert werden (Ort, Branche, Zentralitätsmasse etc.)
# Hier werden Kanten entfernt, welche eine Gewichtung <= 1 aufweisen. Das heisst, es werden nur 
# Organisationen berücksichtigt, welche sich mehr als 1 Parlamentarier:in "teilen"

# in einem ersten Schritt muss dazu ein Filterungsindex erstellt werden
index_org <- SR_organisationen_tidy %>%
  activate(edges) %>% 
  filter(weight > 1) %>% 
  as_tibble() %>% 
  select(from, to)

index_org <- c(index_org$from, index_org$to) %>% 
  unique()

set.seed(12345)
SR_organisationen_tidy %>%
  activate(edges) %>% 
  filter(weight > 1) %>% 
  activate(nodes) %>% 
  slice(index_org) %>% 
  ggraph(layout = "fr") +
  geom_edge_link(aes(width = weight),
                 alpha = 0.5,
                 show.legend = FALSE) +
  geom_node_point(aes(color = industry_org,
                      size  = degree)) +
  geom_node_text(aes(label = name),
                 repel = TRUE,
                 size = 3) +
  scale_edge_width(range = c(0.2, 0.8)) +
  scale_size(range = c(1, 6)) + 
  labs(title = "Organisationsnetzwerk - Geteilte Parlamentarier:innen",
       subtitle = "Je breiter die Kanten, desto mehr Parlamentarier:innen 'teilen' sich die Organisationen",
       size = "Degree",
       color = "Branche",
       caption = "Organisationen mit einer Gewichtung von <= 1 wurden herausgefiltert.")
```


```{r}
# Parlamentarier:innen
set.seed(12345)
SR_parlamentarier_tidy %>% 
  ggraph(layout = "fr") +
  geom_edge_link(aes(width = weight),
                 color = "grey",
                 show.legend = FALSE) + 
  geom_node_point(aes(color = party,
                      size = degree)) +
  geom_node_text(aes(label = name),
                 size = 4,
                 repel = TRUE) + 
  scale_color_manual(values = c("FDP" = "cornflowerblue", 
                                "Grüne" = "chartreuse2", 
                                "M" = "darkorange", 
                                "SP" = "brown1", 
                                "SVP" = "chartreuse4", 
                                "Parteilos" = "grey")) + 
  scale_edge_width(range = c(0.5, 1)) + 
  scale_size(range = c(4, 10)) + 
  labs(title = "Ständerätliches Netzwerk - Gemeinsame Einsitze in Organisationen",
       subtitle = "Je breiter die Kanten, desto mehr Organisationen 'teilen' sich die Parlamentarier:innen",
       size = "Degree",
       color = "Partei")
```



# Community Detection

In der Netzwerksoziologie wird eine Comminity als Subste der Nodes mit einer höhrene Kantendichte als der Rest des Netzwerkes definiert (Vergleich Radichhi et. al 2004). Um diese Subsets zu identifizieren wird eine Auswahl an Algorithmen verwendet, wie sie auch von Douglas A. Luke in seiner User's Guide to Network Analysis vorgeschlagen werden.

Die Interpretation der identifizierten Communities bleibt dabei in den Händen der Forschenden und die Algorithmen machen tätigen jeweils keine qualitätive Einordnung der identifizierten Subsets.

## Communities: Parlamentarier:innen

Die Community Detection wird sowohl auf die Parlamentarier:innen als auch das Organisationsnetzwerk angewendet. Basierend auf Douglas A. Lukes Methode (vgl. Luke 2015: 118) versuchen wir in einem ersten Schritt den Algorithmus zu finden, welcher den höchsten Modularitätswert vorweist. 

Im Falle der Parlamentarier:innen wäre dies *Louvian*.

```{r}

## Auswahl des Algorithmus mit der besten Modularität für das Parlamentarier:innen-Netzwerk

# Fast & Greedy
fg_p <- modularity(
  cluster_fast_greedy(SR_parlamentarier_tidy)
  )

# Infomap
in_p <- modularity(
  cluster_infomap(SR_parlamentarier_tidy)
  )

# Edge Betweenness
eb_p <- modularity(
  cluster_edge_betweenness(SR_parlamentarier_tidy)
  )

# Louvian
lv_p <- modularity(
  cluster_louvain(SR_parlamentarier_tidy)
  )


## Dataframe
Algorithm <- c("Fast & Greedy",
               "Infomap",
               "Edge Betweenness",
               "Louvian")

Modularity <- c(fg_p,
                in_p,
                eb_p,
                lv_p )

kable(data.frame(Algorithm,Modularity),
      caption = "Tabelle 1: Modularity Scores des Parlamentarier:innen-Netzwerks basierend auf verschiedenen Community-Algorithmen")
```

Wendet man den Algorithmus auf das Netzwerk an, so werden insgesamt sieben verschiedene Communities identifiziert. Zwei dieser sieben lasssen sich dadurch erklären, dass sie atomisierte und innerhalb des Netzwerkes nicht verbundene Politiker:innen darstellen (Community 6 und 7).

Communities eins und zwei weisen eine starke Überschneidung auf und hier sind keine klaren Parteimuster zu erkennen. Gerade in Community 2 sind die Parteien mit vier Grünen und jeweils drei Politiker:innen der SP und SVP relativ ausgeglichen. 

Spannender wird die identifizierte Community 3, welche aussschliesslich aus FDP und Mitte-Politiker:innen besteht und somit ein klares mitte-rechts-Bias besitzt.


```{r}
# Parlamentarier:innen - Community
set.seed(12345)
SR_parlamentarier_tidy %>% 
  mutate(group_louvain= as.factor(group_louvain())) %>% 
  ggraph(layout = "fr") +
  geom_edge_link(aes(width = weight),
                 color = "grey",
                 show.legend = FALSE) + 
  geom_node_point(aes(color = party,
                      size = degree)) +
  geom_node_text(aes(label = name),
                 size = 4,
                 repel = TRUE) + 
  geom_mark_hull(aes(x = x, 
                     y = y, 
                     fill = group_louvain, 
                     label = group_louvain),
                 concavity = 6) +
  scale_color_manual(values = c("FDP" = "cornflowerblue", 
                                "Grüne" = "chartreuse2", 
                                "M" = "darkorange", 
                                "SP" = "brown1", 
                                "SVP" = "chartreuse4", 
                                "Parteilos" = "grey")) + 
  scale_edge_width(range = c(0.5, 1)) + 
  scale_size(range = c(4, 10)) + 
  labs(title = "Ständerätliches Netzwerk - Gemeinsame Einsitze in Organisationen | Communities",
       subtitle = "Communities anhand Algorithmus Louvian ausgearbeitet",
       size = "Degree",
       color = "Partei")
```

## Communities: Organisationen

Wesentlich spannender und eindeutiger gestaltet sich die Community Detection bei den Organisationen. Alle verwendeten Algorithmen kommen hier auf ähnliche Modularitätswert. Der Einfachheit und Vergleichbarkeit halber wurde auch hier der *Louvian*-Algorithmus weitervwerendet.

```{r}

## Auswahl des Algorithmus mit der besten Modularität für das Parlamentarier:innen-Netzwerk
SR_organisationen_tidy_com <- SR_organisationen_tidy %>%
  activate(edges) %>% 
  filter(weight > 1)

# Fast & Greedy
fg_o <- modularity(
  cluster_fast_greedy(SR_organisationen_tidy_com)
  )

# Infomap
in_o <- modularity(
  cluster_infomap(SR_organisationen_tidy_com)
  )

# Edge Betweenness
eb_o <- modularity(
  cluster_edge_betweenness(SR_organisationen_tidy_com)
  )


# Louvian
lv_o <- modularity(
  cluster_louvain(SR_organisationen_tidy_com)
  )

## Dataframe
Algorithm <- c("Fast & Greedy",
               "Infomap",
               "Edge Betweenness",
               "Louvian")

Modularity <- c(fg_o,
                in_o,
                eb_o,
                lv_o)

kable(data.frame(Algorithm,Modularity),
      caption = "Tabelle 2:Modularity Scores des Organisationsnetzwerks basierend auf verschiedenen Community-Algorithmen")
```


Insgesamt konnten 12 distinkte Communities Identifiziert werden. Darunter das primär wirtschaftlich geprägte Netzwerk um die Universität Zürich (Community 1), das ostschweizerische Netzwerk um die Universität St.Gallen (Community 2), Sport und Freizeit in Community 3, Politische Inklusion mit einem Flavour von Ökologie in Community 5, die Glarner Comminity in Community 6, das Zentralschweizer Netz in Community 7, Umwelt und Verkehr in Communities 8 und 9.

Communities 4, 10, 11 und 12 konnten nicht klar identifiziert werden, eine Übersicht findet sich in der Tabelle 3



```{r}
# Organisationen - Community
set.seed(12345)

SR_organisationen_tidy_com  %>% 
  activate(nodes) %>% 
  slice(index_org) %>% 
  mutate(group_louvain= as.factor(group_louvain())) %>% 
  ggraph(layout = "fr") +
  geom_edge_link(aes(width = weight),
                 alpha = 0.5,
                 show.legend = FALSE) +
  geom_node_point(aes(color = industry_org,
                      size  = degree)) +
  geom_node_text(aes(label = name),
                 repel = TRUE,
                 size = 3) +
   geom_mark_hull(aes(x = x, 
                     y = y, 
                     fill = group_louvain, 
                     label = group_louvain),
                 concavity = 6) +
  scale_edge_width(range = c(0.2, 0.8)) +
  scale_size(range = c(1, 6)) + 
  labs(title = "Organisationsnetzwerk - Geteilte Parlamentarier:innen",
       subtitle = "Je breiter die Kanten, desto mehr Parlamentarier:innen 'teilen' sich die Organisationen",
       size = "Degree",
       color = "Branche",
       caption = "Organisationen mit einer Gewichtung von <= 1 wurden herausgefiltert.")
```


```{r}
Communities <- c()

for(i in 1:12){
  text <- paste("Community ", as.character(i))
  Communities <- append(Communities, text)
}

Kategorie <-  c("Wirtschaft Zürich",
            "Ostschweizer Netzwerk",
            "Sport und Freizeit",
            "-",
            "Politische Inklusion und Ökologie",
            "Glarner Community",
            "Zentralschweizer Netz",
            "Umwelt und Verkehr",
            "Umwelt und Verkehr",
            "-",
            "-",
            "-")

kable(as.data.frame(Communities, Kategorie),
      caption = "Tabelle 3: Interpretation der Communities im organisationalen Netzwerk")
```

# Weiterführende Literatur

Radicchi,Filippo; Claudio Castellano; Federico Cecconi; Vittorio Loreto; Domenico Parisi (2004): Defining and identifying communities in networks, Proceedings of the National Academy of Sciences, Volume 101, doi:10.1073/pnas.0400054101
